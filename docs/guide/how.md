# 原理

## 代码扫描

为了实现 **「尽可能像开发普通业务一样开发有国际化需求的业务」** 这个目标，我们允许开发者在进行功能开发时，无需考虑文案国际化的需求，「写中文的地方，照样写中文」。等到功能开发、测试完毕后，再单独进行一次国际化的迭代。

这时只需要执行 `sync` 命令, di18n 将自动扫描代码，抽取出需要翻译的中文字符串，自动分配资源 key，并修改源码为 `intl` 框架需要的格式，比如 `intl.get('key1').d('标题');`。同时将自动同步配置服务上相关联的配置文件（**自动删除代码不再使用的 key，自动添加新引入的 key**）。

需要注意的是，由于国际化带来的样式问题，仍需 FE 同学自行修复。

di18n 会先按如下步骤扫描源码：

- 使用 Babel 解析得到 AST，遍历 AST，并对特殊的节点进行检查，抽取出需要翻译的字符串；
- 自动为每一个字符串分配一个 key；
- 自动调用 Google 翻译服务（可选），得到一个英文的字符串。

> 注：对于 React，上面提到的特殊节点包括： `JSXText` `StringLiteral` `TemplateLiteral` 等。

扫描之后，对于源代码：

- 构造 `CallExpression` 表达式 `intl.get('key1').d('xxx');`；
- 替换原有节点 `path.replaceWith(newNode)`；
- 将新的 AST 通过 Babel 转换为代码；
- 使用 Prettier 格式化代码；
- 将新的代码落盘。

对于国际化资源：

- 将 key-value 转换为 i18n 配置文件格式。

## 流程图

![](../images/di18n_work_flow.jpg)
